# Program 路由动态化重构详细说明

## 重构背景与目标

### 背景
- 原 Program 路由为硬编码 (`/program/aigc-intermediate`, `/program/ai-designer-advanced`)
- 与 Course 路由动态化模式不一致，存在技术债务
- 为未来 SSG 迁移做准备

### 目标
- 实现 Program 路由动态化，统一路由模式
- 与 Course 路由架构保持一致
- 支持 SEO 优化
- 为 SSG 迁移预留清晰路径

## 重构范围与阶段

### 重构阶段
1. **Phase 1**: JSON-LD 注入 (已完成)
2. **Phase 2**: 路由动态化 (已完成)
3. **Phase 3**: SEO 保护与优化 (已完成)
4. **Phase 4**: SSG 迁移 (未来计划)

### 核心提交
- `7404a3e`: 路由动态化 PRD 完成，包含评测报告和实施建议
- `bbfd171`: SSG 迁移前准备工作完成，包含质量验证和文档更新

## 具体修改文件与作用

### 1. 类型定义扩展

**文件**: `src/types/index.ts`

**修改内容**:
- 新增 `Program` 接口定义
- 新增 `ProgramBenefit` 接口定义
- 新增 `PROGRAM_SLUGS` 常量数组
- 新增 `assertProgramSlug` 运行时校验函数

**作用**:
- 为 Program 路由提供完整的 TypeScript 类型支持
- 确保路由参数的类型安全
- 支持运行时校验，实现 fail-fast 机制

### 2. 状态管理扩展

**文件**: `src/store/courseStore.ts`

**修改内容**:
- 新增 `mockPrograms` 数组，存储 Program 配置
- 新增 `getProgramBySlug` getter 方法
- 新增 `programExists` getter 方法
- 新增 `getProgramCourses` getter 方法

**作用**:
- 统一管理 Program 配置和 Course 数据
- 提供便捷的 Program 数据访问方法
- 支持根据 Program slug 获取对应的课程列表

### 3. 路由配置更新

**文件**: `src/router/index.ts`

**修改内容**:
- 移除硬编码的 ProgramA 和 ProgramB 路由
- 新增动态路由 `/program/:slug`
- 添加 `beforeEnter` 路由守卫

**作用**:
- 实现 Program 路由动态化
- 验证 Program 存在性，不存在则重定向到 404
- 统一路由模式，与 Course 路由架构保持一致

### 4. 动态组件创建

**文件**: `src/views/program/[slug].vue`

**修改内容**:
- 创建动态 Program 组件，替换原有的 ProgramAView.vue 和 ProgramBView.vue
- 集成 JSON-LD 结构化数据
- 实现动态 Meta 标签管理
- 添加 Advanced 课程空状态提示

**作用**:
- 支持所有 Program 类型的动态渲染
- 实现动态 Meta 标签和 JSON-LD 生成
- 提供友好的空状态提示

### 5. JSON-LD 工具函数

**文件**: `src/utils/jsonld/buildProgramJsonLd.ts`

**修改内容**:
- 新增 `buildProgramJsonLd` 工具函数
- 支持 Schema.org EducationalOccupationalProgram 类型
- 支持 Level/Type/Access/Outcome/Pathway 五维字段

**作用**:
- 生成符合 Schema.org 标准的 JSON-LD 结构化数据
- 提升 SEO 效果
- 支持 Rich Results 展示

### 6. Sitemap 生成脚本

**文件**: `scripts/generate-sitemap.js`

**修改内容**:
- 新增 Sitemap 自动生成脚本
- 集成到构建流程
- 支持生成包含 Program URL 的 sitemap.xml

**作用**:
- 自动生成包含 Program 页面的 sitemap
- 无需手动维护 sitemap
- 集成到构建流程，确保 sitemap 与实际路由同步

### 7. 项目文档更新

**文件**: `CLAUDE.md` (根目录) 和 `frontend/CLAUDE.md`

**修改内容**:
- 添加 Program 路由动态化状态记录
- 更新路由设计模式说明
- 添加 SEO 优化状态章节
- 记录 SSG 迁移准备情况

**作用**:
- 保持文档与代码实现同步
- 提供清晰的路由使用指南
- 记录架构变更和技术决策

## 重构成果与效果

### 架构设计
- ✅ **统一路由模式**: Course 和 Program 使用相同的动态路由架构
- ✅ **数据层一致性**: Program 配置纳入 courseStore 统一管理
- ✅ **类型安全**: 完整的 TypeScript 类型定义和运行时校验
- ✅ **渐进式准备**: 为 SSG 迁移预留清晰升级路径

### SEO 优化
- ✅ **完整的 Meta 标签**: 支持所有主流社交平台
- ✅ **Schema.org 标准**: JSON-LD 符合 EducationalOccupationalProgram 规范
- ✅ **自动化 Sitemap**: 集成构建流程，无需手动维护
- ✅ **爬虫友好**: robots.txt 精确控制抓取范围

### 代码质量
- ✅ **0 TypeScript 错误**: 严格的类型检查通过
- ✅ **构建成功**: 生产环境可部署
- ✅ **组件复用**: 充分利用现有 CourseCard、BreadcrumbNav 等组件
- ✅ **清理机制**: onUnmounted 确保 Meta 标签无泄漏

## 技术决策说明

### 1. SPA 架构 vs SSG 架构

**当前**: SPA 架构 + `beforeEnter` 路由守卫
**未来**: SSG 架构 + `onBeforeRender` 钩子

**决策理由**: 
- 保持现有架构稳定性
- 为 SSG 迁移预留清晰路径
- 避免过早引入新技术带来的风险

### 2. 动态 Meta 标签实现

**决策**: 使用原生 DOM 操作而非 @vueuse/head

**理由**:
- 避免引入新依赖，保持项目轻量
- 当前只有 Program 页面需要动态 Meta
- 原生 API 清理逻辑简单可控
- 未来迁移 SSG 时可轻松替换为 `useHead`

### 3. Sitemap 生成策略

**决策**: 通过正则表达式扫描 courseStore.ts 源码

**理由**:
- 无需引入额外构建工具
- 与数据源保持单一真相 (Single Source of Truth)
- 自动化程度高，新增课程无需手动维护 sitemap
- 集成到构建流程，确保 sitemap 与实际路由同步

## 后续建议与注意事项

### 立即可做
1. 本地测试 Program 路由，验证功能完整性
2. 验证 Sitemap 正确性

### 网站上线后执行
1. 提交 Sitemap 到搜索引擎
2. 监控 SEO 指标
3. 定期检查结构化数据错误

### SSG 迁移时 (Phase 4)
1. 安装 vite-plugin-ssr
2. 重命名文件: `[slug].vue` → `[slug]/+Page.vue`
3. 创建服务端文件: `[slug]/+Page.server.ts`
4. 实现钩子: `onBeforeRender` + `prerender`
5. 替换原生 DOM 为 `useHead`

## 结论

本次 Program 路由动态化重构成功实现了以下目标：

1. **统一路由模式**: Course 和 Program 现在使用相同的动态路由架构
2. **提升可维护性**: 减少了硬编码路由，便于未来扩展
3. **增强 SEO 效果**: 实现了动态 Meta 标签和 JSON-LD 结构化数据
4. **为 SSG 迁移做好准备**: 预留了清晰的迁移路径

重构后的架构更加统一、灵活，并且为未来的技术升级打下了坚实的基础。