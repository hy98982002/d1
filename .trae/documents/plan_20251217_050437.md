# 路由和Slug运行机制讲解

## 1. slug.ts文件详解

### 核心功能

slug.ts是一个**Slug生成、解析和验证工具库**，主要用于：

* 生成规范的课程slug

* 解析slug获取课程信息

* 验证slug格式有效性

* 生成标准化URL

### 关键函数

| 函数名                    | 功能                | 应用场景        |
| ---------------------- | ----------------- | ----------- |
| `generateCourseSlug()` | 根据课程标题和阶段生成规范slug | 课程创建/编辑时    |
| `parseSlug()`          | 从slug解析出阶段和课程名称   | 页面加载时提取信息   |
| `isValidSlug()`        | 验证slug格式是否合法      | 路由守卫/表单验证   |
| `getCourseUrl()`       | 生成标准化课程URL        | 链接生成时       |
| `getProgramUrl()`      | 生成标准化Program URL  | Program链接生成 |

## 2. 路由守卫工作原理

### 当前实现

在`router/index.ts`的路由守卫中：

```typescript
const slug = to.params.slug as string // 1. 获取URL中的slug参数
const course = courseStore.getCourseBySlug(slug) // 2. 直接从store中查找
if (!course) { return '/404' } // 3. 不存在则重定向404
```

### 协作关系分析

**当前问题**：路由守卫**没有直接调用**`slug.ts`进行验证或修改！

* ✅ `slug.ts`主要用于**生成阶段**，确保创建的slug符合规范

* ❌ 路由守卫**仅做存在性检查**，不验证slug格式合法性

* ❌ 没有对用户输入的slug进行规范化处理

## 3. 改进方案：增强路由守卫与slug.ts的协作

### 优化点1：添加slug格式验证

```typescript
import { isValidSlug } from '@/utils/slug'

beforeEnter: (to, from) => {
  const slug = to.params.slug as string
  
  // 新增：验证slug格式合法性
  if (!isValidSlug(slug)) {
    return '/404' // 格式非法直接404
  }
  
  const course = courseStore.getCourseBySlug(slug)
  if (!course) {
    return '/404'
  }
  
  return true
}
```

### 优化点2：实现slug自动规范化

```typescript
import { parseSlug, generateCourseSlug } from '@/utils/slug'

beforeEnter: (to, from) => {
  const rawSlug = to.params.slug as string
  
  try {
    // 尝试解析slug获取课程信息
    const { stage, courseName } = parseSlug(rawSlug)
    
    // 生成规范化的slug
    const normalizedSlug = generateCourseSlug(courseName, stage)
    
    // 如果slug不一致，重定向到规范版本
    if (rawSlug !== normalizedSlug) {
      return { name: to.name, params: { slug: normalizedSlug } }
    }
    
    // 继续验证课程存在性
    const course = courseStore.getCourseBySlug(normalizedSlug)
    if (!course) {
      return '/404'
    }
    
    return true
  } catch {
    // 解析失败，直接404
    return '/404'
  }
}
```

## 4. 完整的Slug生命周期

1. **创建阶段**：使用`generateCourseSlug()`生成规范slug并存入数据库
2. **访问阶段**：

   * 用户输入URL：`/course/invalid-slug-format`

   * 路由守卫拦截，调用`isValidSlug()`验证

   * 格式非法：返回404

   * 格式合法：调用`parseSlug()`提取信息

   * 生成规范slug，对比原始输入

   * 不一致：重定向到规范URL

   * 一致：验证资源存在性
3. **页面加载**：使用`parseSlug()`提取阶段信息，渲染对应内容

## 5. 代码改进建议

1. **增强路由守卫**：添加slug格式验证
2. **实现自动规范化**：重定向到规范slug版本
3. **统一Slug处理**：所有slug相关操作都通过slug.ts进行
4. **完善错误处理**：提供更友好的404页面
5. **添加日志记录**：便于调试和监控

## 6. 总结

当前系统中，`slug.ts`主要用于**生成阶段**，确保创建的slug符合规范；而**访问阶段**的路由守卫仅做简单的存在性检查，没有充分利用`slug.ts`的验证和规范化能力。

通过增强路由守卫与`slug.ts`的协作，可以：

* 提高系统的鲁棒性，处理各种非法slug

* 确保URL的规范化，提升SEO效果

* 提供更好的用户体验，自动纠正URL错误

* 统一Slug处理逻辑，便于维护和扩展

